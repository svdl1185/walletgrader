<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jeet Checker</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body class="light">
    <main class="container">
      <header class="header">
        <h1>Jeet Checker</h1>
        <p class="subtitle">Enter a Solana address or Twitter @ to get a score.</p>
      </header>

      <form method="post" class="form" id="grade-form">
        <div class="row">
          <input type="text" id="address" name="address" placeholder="e.g. 4Nd1m7... or @handle" value="" autofocus />
          <button type="submit">Grade</button>
        </div>
        {% if error %}
        <div class="alert error">{{ error }}</div>
        {% endif %}
      </form>

      <section class="results" id="results" style="display:none;">
        <div class="score-line" id="score-line" style="display:none;">
          <div class="score-label"><span id="score-value"></span> — <span id="score-name"></span></div>
          <div class="score-heuristics">
            <span id="heur-hold"></span> • <span id="heur-activity"></span>
          </div>
        </div>
        <div class="score-bar" id="score-bar" data-final-score="0">
          <div class="bar-header">
            <span>1</span>
            <span>100</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill"></div>
            <div class="bar-marker" aria-hidden="true"></div>
          </div>
        </div>
        <div class="score-meta" id="score-meta" style="display:none; text-align:center; color:#666; font-size:13px; margin-top:6px;"></div>
      </section>

      <div class="foot-link"><a href="https://github.com/svdl1185/walletgrader" target="_blank" rel="noopener noreferrer">Github</a></div>
    </main>
    <script>
      (function() {
        const form = document.getElementById('grade-form');
        const results = document.getElementById('results');
        const bar = document.getElementById('score-bar');
        const scoreLine = document.getElementById('score-line');
        const scoreValue = document.getElementById('score-value');
        const scoreName = document.getElementById('score-name');
        const heurHold = document.getElementById('heur-hold');
        const heurActivity = document.getElementById('heur-activity');
        const scoreMeta = document.getElementById('score-meta');
        if (!form || !results || !bar) return;
        const marker = bar.querySelector('.bar-marker');
        const fill = bar.querySelector('.bar-fill');

        function setPosition(pct) {
          const clamped = Math.max(0, Math.min(100, pct));
          marker.style.setProperty('--marker-position', String(clamped));
          fill.style.setProperty('--fill-percentage', String(clamped));
          const hue = clamped < 80 ? 50 * (clamped / 80) : 50 + 70 * ((clamped - 80) / 20);
          fill.style.setProperty('--bar-hue', String(Math.round(hue)));
        }

        let hoverRAF = 0;
        function startHovering() {
          let position = Math.floor(Math.random() * 101);
          let direction = Math.random() > 0.5 ? 1 : -1;
          const speed = 0.05; // percent per ms (slow)
          marker.classList.add('hovering');
          fill.classList.add('hovering');
          let last = performance.now();
          function step(now) {
            const dt = Math.min(32, now - last); last = now;
            position += direction * speed * dt;
            if (position >= 100) { position = 100; direction = -1; }
            if (position <= 0) { position = 0; direction = 1; }
            setPosition(position);
            hoverRAF = requestAnimationFrame(step);
          }
          setPosition(position);
          hoverRAF = requestAnimationFrame(step);
        }

        function stopHoveringAndSet(finalScore) {
          if (hoverRAF) cancelAnimationFrame(hoverRAF);
          marker.classList.remove('hovering');
          fill.classList.remove('hovering');
          marker.classList.add('settle');
          fill.classList.add('settle');
          setPosition(finalScore);
        }

        // Quick scan only

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const address = (document.getElementById('address') || {}).value || '';
          if (!address.trim()) return;
          results.style.display = 'block';
          marker.classList.remove('settle');
          fill.classList.remove('settle');
          setPosition(Math.floor(Math.random() * 100));
          startHovering();
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);
            const isTwitter = /^@|twitter\.com\/|x\.com\//i.test(address);
            const endpoint = isTwitter ? '/grade_twitter' : '/grade';
            const payload = isTwitter ? { handle: address } : { address };
            const resp = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
            clearTimeout(timeoutId);
            let data = {};
            try { data = await resp.json(); } catch (e) { data = {}; }
            if (!resp.ok) throw new Error(data.error || 'Failed');
            stopHoveringAndSet(Math.max(1, Math.min(100, parseInt(data.score, 10) || 0)));
            scoreLine.style.display = 'block';
            scoreValue.textContent = String(data.score);
            scoreName.textContent = String(data.label);
            if (data.handle) {
              heurHold.textContent = `Unique coins: ${data.metrics.unique_coins}`;
              heurActivity.textContent = `Mentions: ${data.metrics.total_mentions}`;
              scoreMeta.style.display = 'block';
              scoreMeta.textContent = `Avg 1h: ${data.metrics.avg_change_1h ?? 0}% | Avg 6h: ${data.metrics.avg_change_6h ?? 0}% | Avg 24h: ${data.metrics.avg_change_24h ?? 0}%`;
            } else {
              heurHold.textContent = `Hold profile: ${data.metrics.hold_profile}`;
              heurActivity.textContent = `Activity profile: ${data.metrics.activity_profile}`;
              scoreMeta.style.display = 'none';
              scoreMeta.textContent = '';
            }
          } catch (e) {
            stopHoveringAndSet(1);
            alert('Network error');
          }
        });
      })();
    </script>
  </body>
  </html>


