<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jeet Checker</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body class="light">
    <main class="container">
      <header class="header">
        <h1>Jeet Checker</h1>
        <p class="subtitle">Enter a Twitter @handle or profile link to get a reliability score.</p>
      </header>

      <form method="post" class="form" id="grade-form">
        <div class="row">
          <input type="text" id="handle" name="handle" placeholder="e.g. @basedcaller or https://x.com/user" value="" autofocus />
          <button type="submit">Grade</button>
        </div>
        {% if error %}
        <div class="alert error">{{ error }}</div>
        {% endif %}
      </form>

      <section class="results" id="results" style="display:none;">
        <div class="score-line" id="score-line" style="display:none;">
          <div class="score-label"><span id="score-value"></span> — <span id="score-name"></span></div>
          <div class="score-heuristics">
            <span id="heur-hold"></span> • <span id="heur-activity"></span>
          </div>
        </div>
        <div class="score-bar" id="score-bar" data-final-score="0">
          <div class="bar-header">
            <span>1</span>
            <span>100</span>
          </div>
          <div class="bar-track">
            <div class="bar-fill"></div>
            <div class="bar-marker" aria-hidden="true"></div>
          </div>
        </div>
        <div class="score-meta" id="score-meta" style="display:none; text-align:center; color:#666; font-size:13px; margin-top:6px;"></div>
        <div id="calls-list" style="display:none; margin-top:12px;"></div>
      </section>

      <div class="foot-link"><a href="https://github.com/svdl1185/walletgrader" target="_blank" rel="noopener noreferrer">Github</a></div>
    </main>
    <script>
      (function() {
        const form = document.getElementById('grade-form');
        const results = document.getElementById('results');
        const bar = document.getElementById('score-bar');
        const scoreLine = document.getElementById('score-line');
        const scoreValue = document.getElementById('score-value');
        const scoreName = document.getElementById('score-name');
        const heurHold = document.getElementById('heur-hold');
        const heurActivity = document.getElementById('heur-activity');
        const scoreMeta = document.getElementById('score-meta');
        if (!form || !results || !bar) return;
        const marker = bar.querySelector('.bar-marker');
        const fill = bar.querySelector('.bar-fill');

        function setPosition(pct) {
          const clamped = Math.max(0, Math.min(100, pct));
          marker.style.setProperty('--marker-position', String(clamped));
          fill.style.setProperty('--fill-percentage', String(clamped));
          const hue = clamped < 80 ? 50 * (clamped / 80) : 50 + 70 * ((clamped - 80) / 20);
          fill.style.setProperty('--bar-hue', String(Math.round(hue)));
        }

        let hoverRAF = 0;
        function startHovering() {
          let position = Math.floor(Math.random() * 101);
          let direction = Math.random() > 0.5 ? 1 : -1;
          const speed = 0.05; // percent per ms (slow)
          marker.classList.add('hovering');
          fill.classList.add('hovering');
          let last = performance.now();
          function step(now) {
            const dt = Math.min(32, now - last); last = now;
            position += direction * speed * dt;
            if (position >= 100) { position = 100; direction = -1; }
            if (position <= 0) { position = 0; direction = 1; }
            setPosition(position);
            hoverRAF = requestAnimationFrame(step);
          }
          setPosition(position);
          hoverRAF = requestAnimationFrame(step);
        }

        function stopHoveringAndSet(finalScore) {
          if (hoverRAF) cancelAnimationFrame(hoverRAF);
          marker.classList.remove('hovering');
          fill.classList.remove('hovering');
          marker.classList.add('settle');
          fill.classList.add('settle');
          setPosition(finalScore);
        }

        // Quick scan only

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const handle = (document.getElementById('handle') || {}).value || '';
          if (!handle.trim()) return;
          results.style.display = 'block';
          marker.classList.remove('settle');
          fill.classList.remove('settle');
          setPosition(Math.floor(Math.random() * 100));
          startHovering();
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);
            const endpoint = '/grade_twitter';
            const payload = { handle };
            const resp = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal });
            clearTimeout(timeoutId);
            let data = {};
            try { data = await resp.json(); } catch (e) { data = {}; }
            if (!resp.ok) throw new Error(data.error || 'Failed');
            stopHoveringAndSet(Math.max(1, Math.min(100, parseInt(data.score, 10) || 0)));
            scoreLine.style.display = 'block';
            scoreValue.textContent = String(data.score);
            scoreName.textContent = String(data.label);
            heurHold.textContent = `Unique coins: ${data.metrics.unique_coins}`;
            heurActivity.textContent = `Total calls: ${data.metrics.total_calls}`;
            scoreMeta.style.display = 'none';
            scoreMeta.textContent = '';

            // Build calls list
            const callsList = document.getElementById('calls-list');
            if (Array.isArray(data.coins)) {
              const items = [];
              for (const c of data.coins) {
                const sym = c.symbol || c.id;
                const addr = c.address || c.id;
                const liq = c.liquidity_usd ? ` | Lq: $${Math.round(c.liquidity_usd).toLocaleString()}` : '';
                const dexLink = addr ? `https://dexscreener.com/solana/${addr}` : '#';
                const header = `<div style="font-weight:700; margin-top:8px;">${sym} <a href="${dexLink}" target="_blank" rel="noopener noreferrer" style="color:#2b6cf0; text-decoration:none;">(chart)</a>${liq}</div>`;
                const calls = Array.isArray(c.calls) ? c.calls : [];
                const rows = calls.map(ev => {
                  const when = ev.created_at ? new Date(ev.created_at).toLocaleString() : 'time unknown';
                  const approx = typeof ev.approx_since_call_pct === 'number' ? `${ev.approx_since_call_pct.toFixed(1)}%` : 'n/a';
                  const tw = ev.tweet_id ? ` | <a href="https://x.com/i/web/status/${ev.tweet_id}" target="_blank" rel="noopener noreferrer" style="color:#2b6cf0; text-decoration:none;">tweet</a>` : '';
                  let lt = '';
                  if (ev.longterm && typeof ev.longterm === 'object') {
                    const h24 = ev.longterm['24h'];
                    const d7 = ev.longterm['7d'];
                    const d30 = ev.longterm['30d'];
                    const parts = [];
                    if (typeof h24 === 'number') parts.push(`24h ${h24.toFixed(1)}%`);
                    if (typeof d7 === 'number') parts.push(`7d ${d7.toFixed(1)}%`);
                    if (typeof d30 === 'number') parts.push(`30d ${d30.toFixed(1)}%`);
                    lt = parts.length ? ` | ${parts.join(' · ')}` : '';
                  }
                  return `<div style="font-size:13px; color:#333;">- ${when} — ~since-call: ${approx}${tw}${lt}</div>`;
                }).join('');
                items.push(header + rows);
              }
              callsList.innerHTML = items.join('');
              callsList.style.display = items.length ? 'block' : 'none';
            }
          } catch (e) {
            stopHoveringAndSet(1);
            alert('Network error');
          }
        });
      })();
    </script>
  </body>
  </html>


